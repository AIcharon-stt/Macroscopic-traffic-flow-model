# Enhanced CTM 交通流预测模型

## 模型概述

Enhanced CTM（增强元胞传输模型）是一种基于Daganzo元胞传输理论的高级宏观交通流模拟与预测模型。该模型在经典CTM基础上引入了多种增强功能，包括多车型建模、自适应元胞系统、交通状态智能分类以及机器学习集成等创新特性，能够更准确地预测复杂公路网络中的交通流状况。

本模型特别适用于高速公路交通流的短期和中期预测（5-30分钟），可有效处理包含匝道、瓶颈路段在内的复杂道路条件，并能考虑天气、时间段等外部因素对交通流的影响。

## 主要特点

- **多车型精细建模**：区分6种车型（B1-B3客车类，T1-T3货车类）的流量预测
- **交通状态自动分类**：智能识别自由流、过渡流、拥堵流和超拥堵流等不同交通状态
- **自适应元胞系统**：根据交通状态动态调整元胞大小和分布，提高计算效率和精度
- **瓶颈区域精细处理**：增强对瓶颈区域的识别和影响范围的模拟
- **时间依赖参数调整**：根据不同时段（早高峰、晚高峰、平峰等）自动调整模型参数
- **天气影响模拟**：考虑降水和能见度对交通流的影响
- **历史模式集成**：利用历史数据模式辅助预测
- **机器学习增强**：可选的机器学习集成模式，提升预测准确性
- **混合预测模式**：结合物理模型和机器学习的混合预测方法

## 安装与环境要求

### 环境需求
- Python 3.7或更高版本
- NumPy
- Pandas
- SciPy
- scikit-learn（机器学习功能需要）
- TensorFlow（可选，用于高级机器学习功能）
- matplotlib（可选，用于可视化）




```

## 数据格式要求

### 路段数据

模型需要一个包含以下列的CSV文件：

- `id`：路段唯一标识符
- `up_node`：上游门架/检测器ID
- `down_node`：下游门架/检测器ID
- `length`：路段长度（公里）
- `lanes`：车道数（默认：3）
- `speed_limit`：限速（公里/小时）（默认：100）
- `type`：路段类型（1：基本路段，2：有入口匝道，3：有出口匝道，4：同时有入口和出口匝道）
- `bottleneck_factor`（可选）：瓶颈严重程度因子（0-1）
- `curvature`（可选）：道路弯曲程度（0-1）
- `grade`（可选）：道路坡度（百分比，上坡为正）

示例：
```csv
id,up_node,down_node,length,lanes,speed_limit,type
S001,G101,G102,2.5,3,120,1
S002,G102,G103,1.8,2,100,2
```

### 交通流量数据

每个门架/检测器的数据需要创建一个名为`trafficflow_<门架ID>.csv`的文件，包含以下列：

- `Time`：时间戳，格式为'YYYY/MM/DD HH:MM'
- `B1`, `B2`, `B3`, `T1`, `T2`, `T3`：各类型车辆在5分钟间隔内的计数

示例：
```csv
Time,B1,B2,B3,T1,T2,T3
2023/05/01 08:00,45,5,2,8,3,1
2023/05/01 08:05,52,6,1,7,4,2
```

### 天气数据（可选）

CSV文件格式：
- `Time`：时间戳，格式为'YYYY/MM/DD HH:MM'
- `precipitation`：降水量（毫米）
- `visibility`：能见度（米）
- `temperature`：温度（摄氏度）

## 模型参数

### 核心参数

| 参数 | 默认值 | 描述 |
|-----------|---------|-------------|
| `critical_density` | 27.0 veh/km/lane | 临界密度：交通流量最大时的密度 |
| `jam_density` | 180.0 veh/km/lane | 拥堵密度：交通完全停止时的密度 |
| `free_flow_speed` | 110.0 km/h | 自由流速度：在极低密度时的行驶速度 |
| `wave_speed` | 20.0 km/h | 波速：拥堵波向后传播的速度 |
| `alpha` | 2.0 | 基本图形状参数：控制密度-流量关系曲线形状 |
| `beta` | 0.25 | 转换平滑参数：控制不同交通状态间的过渡 |
| `cell_length` | 0.5 km | 基本元胞长度：路段离散化的基本单元长度 |

### 车型参数

每种车型都有特定参数：

| 参数 | 描述 |
|-----------|-------------|
| `length` | 车辆平均长度（米） |
| `max_speed` | 最大速度（公里/小时） |
| `acceleration` | 平均加速度（米/秒²） |
| `deceleration` | 平均减速度（米/秒²） |
| `gap_factor` | 车间距因子 |
| `pce` | 乘用车当量值(PCE) |
| `flow_smoothing` | 流量平滑因子 |

## 使用方法

### 基本命令

```bash
python ctm_model.py --road_data ./path/to/roadETC.csv --flow_dir ./path/to/flow_data
```

### 命令行选项

| 选项 | 描述 |
|--------|-------------|
| `--road_data` | 路段数据CSV文件路径 |
| `--flow_dir` | 包含交通流量数据的目录 |
| `--output_dir` | 输出文件目录（默认：'./enctm_results'） |
| `--weather_data` | 天气数据文件路径（可选） |
| `--alpha` | 基本图形状参数（默认：2.0） |
| `--beta` | 转换平滑参数（默认：0.25） |
| `--adaptive_cells` | 启用自适应元胞系统（默认：启用） |
| `--ml_integration` | 启用机器学习集成（默认：不启用） |
| `--hybrid_prediction` | 启用混合CTM-ML预测（默认：不启用） |
| `--predict_minutes` | 预测时间窗口列表，单位分钟（默认：5 10 15 30） |
| `--calibrate` | 自动校准模型参数 |
| `--visualization` | 启用结果可视化 |
| `--aggregate_by` | 指标聚合方法：'time'（按时间窗口）或'vehicle'（按车型）（默认：'time'） |

### 使用示例

#### 使用默认设置的基本预测

```bash
python ctm_model.py --road_data ./data/roadETC.csv --flow_dir ./data/flow
```

#### 使用自定义参数的预测

```bash
python ctm_model.py --road_data ./data/roadETC.csv --flow_dir ./data/flow --alpha 2.2 --beta 0.3
```

#### 启用机器学习和参数校准的全功能预测

```bash
python ctm_model.py --road_data ./data/roadETC.csv --flow_dir ./data/flow --weather_data ./data/weather.csv --ml_integration --visualization --calibrate --predict_minutes 5 10 15 30
```

## 输出文件

模型会生成以下输出文件：

1. `enctm.log`：详细的模型执行日志
2. `validation_results.csv`：所有验证样本的预测值与实际值对比
3. `overall_metrics.csv`：聚合性能指标（MAE、RMSE、MAPE、R²）
4. `calibration_parameters.json`：校准后的模型参数（如启用校准）
5. `traffic_states.csv`：每个预测的交通状态分类结果
6. `visualization/`目录（如启用可视化）：包含预测结果的图形和可视化

### 指标输出示例

```csv
sample_count,MAE,RMSE,MAPE,R2,aggregation_method
3450,2.854,4.127,9.35,0.8742,time_average
```

## 模型原理

Enhanced CTM模型通过以下核心机制模拟交通流：

### 1. 多分段基本图

模型采用修改的Wu模型来描述密度-流量关系，相比传统的三角形基本图，能更精确描述不同交通状态：

```
q(ρ) = v_f * ρ * (1 - (ρ/ρ_jam)^α) / (1 + β * (ρ/ρ_crit)^α)
```

其中：
- q(ρ)是给定密度ρ下的流量
- v_f是自由流速度
- ρ_jam是拥堵密度
- ρ_crit是临界密度
- α和β是控制曲线形状的参数

### 2. 交通状态分类

模型自动将交通状态分为四类：
- **自由流**：密度 < 0.65 × 临界密度
- **过渡流**：0.65 × 临界密度 ≤ 密度 < 1.15 × 临界密度
- **拥堵流**：1.15 × 临界密度 ≤ 密度 < 0.75 × 拥堵密度
- **超拥堵**：密度 ≥ 0.75 × 拥堵密度

每种状态都有优化的参数集以提高准确性。

### 3. 自适应元胞系统

传统CTM使用固定长度的元胞，而Enhanced CTM根据交通状态动态调整元胞尺寸：
- 自由流状态：较大元胞以提高计算效率
- 过渡流和拥堵流状态：较小元胞以提高精度
- 瓶颈区域：针对瓶颈周围使用特殊的细化元胞

### 4. 发送-接收流量原则

CTM的核心计算原则是：

```
流量(i→i+1) = min(发送流量(i), 接收流量(i+1))
```

其中：
- 发送流量(i) = min(单元i密度 × 自由流速度, 容量)
- 接收流量(i+1) = min(容量, 波速 × (拥堵密度 - 单元i+1密度))
- 容量 = 临界密度 × 自由流速度

## 高级功能

### 时间段适应

模型根据一天中不同时段调整参数：
- **早高峰(7-9点)**：降低速度，加快驾驶员反应时间
- **晚高峰(17-19点)**：进一步降低速度，增强预期效应
- **周末与工作日**：不同的参数调整
- **非高峰/夜间**：提高速度，放缓反应时间

### 瓶颈处理机制

模型采用高级瓶颈检测和处理方法：
1. 静态瓶颈：基于路段数据预定义
2. 动态瓶颈：根据以下指标自动识别
   - 相邻元胞间的流量显著下降
   - 密度急剧增加
   - 从自由流到拥堵流的转变

### 天气影响模型

天气条件通过以下方式影响模拟：
- 降水影响：减少自由流速度和容量
- 能见度影响：在能见度低时更保守的驾驶行为
- 驾驶行为调整：在恶劣天气条件下增加车辆间距

### 机器学习集成

当启用机器学习功能时，模型使用：
- 基于历史数据的流量预测器
- 状态转换分类器
- 参数调整模型

这些模型可以在验证过程中自动训练，并随着更多数据的收集而不断改进。

## 理论背景

Enhanced CTM模型基于以下交通流理论：

1. **连续性方程**：表示车辆守恒原则
2. **元胞传输理论**：Daganzo的经典CTM扩展
3. **多车型交互**：考虑不同车型间的相互影响
4. **交通波传播理论**：模拟拥堵波的形成和传播

该模型综合了以下交通流理论进展：
- 多分段基本图理论
- 瓶颈动力学特征分析
- 空间-时间相关性
- 车辆异质性处理

